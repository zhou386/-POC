# 鸿运(通天星CMSV6车载)主动安全监控云平台任意文件读取漏洞检测工具 README

## 工具简介
本工具用于检测**鸿运(通天星CMSV6车载)主动安全监控云平台**的 `/808gps/StandardReportMediaAction_getImage.action` 接口是否存在**任意文件读取漏洞**。该漏洞通过构造包含Windows系统敏感文件路径的请求参数，可读取服务器上的关键配置文件（如 `C://Windows//win.ini`），工具通过检测目标是否能成功返回 `win.ini` 中的特征内容（`MAPI=1`）来判断漏洞是否存在。

工具支持**单URL精准检测**与**多URL批量检测**，通过多线程（默认50线程）提升批量检测效率，最终将存在漏洞的目标URL自动保存至 `result.txt` 文件，便于后续处理。


## 漏洞背景
### 核心信息
- **漏洞接口**：`/808gps/StandardReportMediaAction_getImage.action`
- **漏洞参数**：`filePath`（指定读取的文件路径）、`fileOffset`（读取起始偏移量）、`fileSize`（读取文件大小）
- **漏洞原理**：接口未对 `filePath` 参数进行路径合法性校验，允许直接传入Windows系统绝对路径（如 `C://Windows//win.ini`），导致攻击者可读取服务器任意可读文件
- **检测依据**：向目标接口发送读取 `C://Windows//win.ini`（Windows系统默认系统配置文件）的请求，若响应中包含 `MAPI=1`（`win.ini` 中固定配置项），则判定目标存在漏洞


## 环境依赖
| 依赖项         | 版本要求       | 说明                     |
|----------------|----------------|--------------------------|
| Python         | 3.6 及以上     | 工具基于Python 3开发，不兼容Python 2 |
| requests       | 2.20.0 及以上  | 用于发送HTTP请求，处理响应数据 |
| multiprocessing | 内置模块     | 基于其 `dummy` 子模块实现多线程批量检测 |

### 依赖安装命令
若本地环境未安装 `requests` 库，执行以下命令快速安装：
```bash
pip install requests
```


## 工具使用说明
### 1. 命令行参数说明
工具通过命令行参数指定检测模式（单URL/多URL），参数含义及用法如下表所示：

| 参数         | 简写 | 功能描述                     | 示例                          |
|--------------|------|------------------------------|-------------------------------|
| `--url`      | `-u` | 指定单个检测目标URL          | `-u http://192.168.0.10:8080` |
| `--file`     | `-f` | 指定包含多个URL的列表文件路径 | `-f target_urls.txt`          |
| `--help`     | `-h` | 查看工具使用帮助文档         | `-h`                          |

### 2. 具体使用场景
#### 场景1：单URL检测（检测单个目标）
适用于验证单个云平台是否存在漏洞，命令格式：
```bash
python 工具文件名.py -u 目标URL
```
**示例**：
```bash
python cmsv6_file_read.py -u http://10.0.0.5:8080
```
- 若目标URL未带 `http://` 或 `https://`，工具会自动补全 `http://`（如输入 `10.0.0.5:8080`，工具会处理为 `http://10.0.0.5:8080`）


#### 场景2：多URL批量检测（检测多个目标）
适用于批量排查企业内部多个云平台资产，需先将目标URL按行存入文本文件，再执行检测命令：
1. **准备URL列表文件**：创建 `targets.txt`，内容格式如下（每行1个URL，支持带端口或不带端口）：
   ```txt
   http://192.168.0.10:8080
   http://192.168.0.11
   192.168.0.12:80  # 工具会自动补全http://
   ```
2. **执行批量检测命令**：
   ```bash
   python cmsv6_file_read.py -f targets.txt
   ```
- 批量检测默认开启 **50线程**，可根据目标服务器性能调整线程数（修改代码中 `Pool(50)` 的数值，如 `Pool(30)` 降低并发压力）


#### 场景3：查看帮助（获取参数说明）
若忘记参数用法，执行以下命令查看工具帮助信息：
```bash
python cmsv6_file_read.py -h
```
**预期输出**：
```
usage: cmsv6_file_read.py [-h] [-u URL] [-f FILE]

鸿运(通天星CMSV6车载)主动安全监控云平台存在任意文件读取漏洞

optional arguments:
  -h, --help            show this help message and exit
  -u URL, --url URL     place input lik (注：原代码注释不完整，实际为“输入单个目标URL”)
  -f FILE, --file FILE  place input your le path (注：原代码注释不完整，实际为“输入URL列表文件路径”)
```


## 输出结果说明
工具运行时会实时在控制台输出检测状态，不同标识对应不同检测结果，便于快速识别目标情况：

| 输出标识 | 结果含义                                                                 | 示例输出                                  |
|----------|--------------------------------------------------------------------------|-------------------------------------------|
| `[+]`    | 目标存在任意文件读取漏洞（已自动写入 `result.txt`）                       | `[+] http://192.168.0.10:8080 存在任意文件读取漏洞` |
| `[-]`    | 目标不存在该漏洞（接口无文件读取权限或已修复）                           | `[-] 该http://192.168.0.11 不存在任意文件读取漏洞` |
| `[*]`    | 目标访问异常（HTTP状态码非200，需手工进一步验证）                        | `[*] 该http://192.168.0.12:80 存在问题,请手工测试` |
| 无输出    | 目标连接失败（如网络不通、端口未开放、超时等，工具捕获异常后跳过）       | -                                         |


## 结果文件说明
工具会自动生成/追加 `result.txt` 文件（位于工具运行目录下），仅保存**存在漏洞的目标URL**，格式为“每行1个URL”，便于后续漏洞验证或修复跟踪。

**示例 `result.txt` 内容**：
```txt
http://192.168.0.10:8080
http://192.168.0.15:8080
```


## 注意事项
1. **合法性声明**：本工具仅用于**合法授权的安全测试**（如企业内部资产自查、经甲方允许的渗透测试），禁止用于未授权的攻击行为，使用者需承担相应法律责任。
2. **线程数调整建议**：
   - 若目标为生产环境服务器，建议将线程数降至 `20-30`，避免高并发请求导致服务器负载过高或服务中断；
   - 若为测试环境资产，可适当提高线程数（如 `50-80`）以提升检测效率。
3. **HTTPS支持**：工具支持检测HTTPS协议的目标，若目标URL以 `https://` 开头，会自动使用HTTPS协议发送请求（无需额外配置）。
4. **漏洞检测范围**：当前工具仅针对Windows系统目标（读取 `C://Windows//win.ini`），若需检测Linux系统目标，需修改 `payload` 为Linux敏感文件路径（如 `/etc/passwd`），并调整漏洞判断条件（如检测 `root:x:0:0:`）。
5. **代码优化建议**：
   - 原代码中 `help` 信息描述不完整（如 `place input lik`），可修改为 `help='输入单个检测目标URL（如http://192.168.0.10:8080）'` 提升可读性；
   - 原代码未捕获具体异常信息，若需排查检测失败原因，可在 `except` 块中添加日志输出（如 `except Exception as e: print(f"[!] {target} 检测异常: {str(e)}")`）。
6. **误报/漏报处理**：若出现误报（显示存在漏洞但实际无），可手动访问 `目标URL+payload` 验证响应内容；若出现漏报（实际存在漏洞但工具未检测到），需检查目标是否正常访问、`payload` 是否适配目标系统。


## 漏洞修复建议（参考）
若检测到目标存在漏洞，可建议运维/开发人员采取以下修复措施：
1. **参数校验**：对 `filePath` 参数进行严格的路径合法性校验，禁止传入绝对路径（如 `C://`、`D://`）或路径穿越符（如 `../`、`../../`）；
2. **白名单限制**：仅允许读取指定目录下的文件（如报表图片目录），通过白名单机制限制文件读取范围；
3. **权限控制**：降低Web服务进程的文件读取权限，避免其能访问 `C://Windows//`、`C://Program Files//` 等敏感目录；
4. **接口停用**：若该接口（`StandardReportMediaAction_getImage.action`）非业务必需，可直接停用该接口以彻底消除风险。
